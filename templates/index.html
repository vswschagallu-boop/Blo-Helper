<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BLO Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; margin:12px; background:#f7f7f7; }
h2 { margin:6px 0; }

.controls {
  display:flex; flex-wrap:wrap; gap:8px;
  background:#fff; padding:10px;
  border-radius:6px;
  box-shadow:0 1px 4px rgba(0,0,0,.15);
}

.controls input, .controls select, .controls button {
  padding:8px; font-size:14px;
}

.controls button {
  background:#1976d2; color:white;
  border:none; border-radius:4px;
}

.controls button.secondary { background:#555; }

#status { margin:10px 0; color:#1976d2; }

#wrap {
  background:white;
  border:1px solid #aaa;
  border-radius:4px;
  max-height:65vh;
  overflow:auto;
}

table { border-collapse:collapse; width:100%; }
th, td { border:1px solid #ccc; padding:6px; white-space:nowrap; }
th { background:#eee; position:sticky; top:0; }

tr.selected { background:#cce5ff; }
mark { background:yellow; padding:0 2px; }

.pagination {
  display:flex; justify-content:center;
  gap:10px; margin-top:8px;
}

@media(max-width:768px){
  .controls{flex-direction:column;}
  .controls input,.controls select,.controls button{width:100%;}
}
</style>
</head>

<body>

<h2>BLO Helper</h2>

<div class="controls">
  <input type="file" id="file">
  <button onclick="uploadExcel()">Upload Excel</button>

  <input id="name" placeholder="Name">
  <select id="nameCol"></select>
  <input id="nameFuzzy" type="number" value="70">

  <input id="relation" placeholder="Relation">
  <select id="relCol"></select>
  <input id="relFuzzy" type="number" value="70">

  <button onclick="startSearch()">Search</button>
  <button class="secondary" onclick="clearSearch()">Clear</button>
</div>

<div id="status">Upload Excel to begin</div>

<div id="wrap">
  <table id="table"></table>
</div>

<div class="pagination">
  <button onclick="prevPage()">◀ Prev</button>
  <span id="pageInfo">Page 0 / 0</span>
  <button onclick="nextPage()">Next ▶</button>
</div>

<script>
let preview=[], rows=[], page=1, pages=0, selected=0;

/* ---------- UPLOAD ---------- */
async function uploadExcel(){
  if(!file.files.length){ alert("Choose Excel"); return; }

  status.innerText="Please wait… Uploading Excel";

  const fd=new FormData();
  fd.append("file",file.files[0]);

  const res=await fetch("/upload",{method:"POST",body:fd});
  const data=await res.json();

  preview=data.preview;
  rows=preview;

  fillDropdowns(data.columns);

  status.innerText=`Loaded ${data.total} rows (preview)`;
  pageInfo.innerText="Preview";

  render(rows);
}

/* ---------- SEARCH ---------- */
function startSearch(){ page=1; fetchPage(); }

async function fetchPage(){
  if(!name.value){ alert("Enter name"); return; }

  status.innerText="Please wait… Searching";

  const res=await fetch("/search",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      name:name.value,
      relation:relation.value,
      name_col:nameCol.value,
      rel_col:relCol.value,
      name_fuzzy:nameFuzzy.value,
      rel_fuzzy:relFuzzy.value,
      page:page
    })
  });

  const data=await res.json();
  rows=data.rows;
  pages=data.pages;
  selected=0;

  status.innerText=`${data.total} results found`;
  pageInfo.innerText=`Page ${page} / ${pages}`;

  render(rows);
}

/* ---------- PAGINATION ---------- */
function nextPage(){ if(page<pages){ page++; fetchPage(); } }
function prevPage(){ if(page>1){ page--; fetchPage(); } }

/* ---------- CLEAR ---------- */
function clearSearch(){
  name.value=""; relation.value="";
  rows=preview; page=1; pages=0;
  status.innerText=`Showing preview (${rows.length})`;
  pageInfo.innerText="Preview";
  render(rows);
}

/* ---------- RENDER ---------- */
function render(data){
  table.innerHTML="";
  if(!data.length)return;

  const headers=Object.keys(data[0]).filter(h=>h!="_matched");

  let tr=document.createElement("tr");
  headers.forEach(h=>{
    let th=document.createElement("th");
    th.innerText=h; tr.appendChild(th);
  });
  table.appendChild(tr);

  data.forEach((r,i)=>{
    let row=document.createElement("tr");
    let matched=r._matched||[];

    headers.forEach(h=>{
      let td=document.createElement("td");
      td.innerHTML=highlight(r[h],matched);
      row.appendChild(td);
    });

    row.onclick=()=>selectRow(i);
    table.appendChild(row);
  });

  highlightRow();
}

function highlight(text,matched){
  return String(text).split(/\s+/).map(w=>{
    return matched.includes(w.toLowerCase())?`<mark>${w}</mark>`:w;
  }).join(" ");
}

function selectRow(i){ selected=i; highlightRow(); }
function highlightRow(){
  [...table.rows].forEach((r,i)=>{
    r.classList.toggle("selected",i===selected+1);
  });
}

function fillDropdowns(cols){
  nameCol.innerHTML="<option value='ALL'>All Columns</option>";
  relCol.innerHTML="<option value='ALL'>All Columns</option>";
  cols.forEach(c=>{
    nameCol.innerHTML+=`<option>${c}</option>`;
    relCol.innerHTML+=`<option>${c}</option>`;
  });
}
</script>

</body>
</html>

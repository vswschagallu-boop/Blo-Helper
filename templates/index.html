<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BLO Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; margin: 12px; background:#f7f7f7; }
h2 { margin: 6px 0; }

.controls {
    display:flex; flex-wrap:wrap; gap:8px;
    background:#fff; padding:10px;
    border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.15);
}

.controls input, .controls select, .controls button {
    padding:8px; font-size:14px;
}

.controls button { background:#1976d2; color:white; border:none; border-radius:4px; }
.controls button.secondary { background:#555; }

#status { margin:10px 0; color:#1976d2; }

#wrap { background:#fff; border:1px solid #aaa; border-radius:4px; max-height:65vh; overflow:auto; }

table { border-collapse:collapse; width:100%; }
th, td { border:1px solid #ccc; padding:6px; white-space:nowrap; }
th { background:#eee; position:sticky; top:0; z-index:2; }

tr.selected { background:#cce5ff; }
mark { background:yellow; padding:0 2px; }

@media (max-width:768px){
  .controls{flex-direction:column;}
  .controls input,.controls select,.controls button{width:100%;}
}
</style>
</head>

<body>

<h2>BLO Helper</h2>

<div class="controls">
    <input type="file" id="file">

    <button onclick="uploadExcel()">Upload Excel</button>

    <input type="text" id="name" placeholder="Name">
    <select id="nameCol"></select>
    <input type="number" id="nameFuzzy" value="70" min="40" max="100">

    <input type="text" id="relation" placeholder="Relation (optional)">
    <select id="relCol"></select>
    <input type="number" id="relFuzzy" value="70" min="40" max="100">

    <button onclick="doSearch()">Search</button>
    <button class="secondary" onclick="clearSearch()">Clear</button>
</div>

<div id="status">Choose Excel file and click Upload</div>

<div id="wrap">
    <table id="table"></table>
</div>

<script>
let preview=[], rows=[], selectedIndex=0;

function setLoading(msg){ status.innerText = msg; }

/* ---------- UPLOAD ---------- */
async function uploadExcel(){
    const f=file.files[0];
    if(!f){ alert("Choose Excel first"); return; }

    setLoading("Please wait… Uploading Excel");

    const fd=new FormData();
    fd.append("file",f);

    const res=await fetch("/upload",{method:"POST",body:fd});
    const data=await res.json();

    preview=data.preview;
    rows=preview;

    populateDropdowns(data.columns);

    setLoading(`Loaded ${data.total} rows (showing first ${preview.length})`);
    render(rows);
}

/* ---------- SEARCH ---------- */
async function doSearch(){
    if(!name.value && !relation.value){
        alert("Enter name or relation");
        return;
    }

    setLoading("Please wait… Searching");

    const res=await fetch("/search",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            name:name.value,
            relation:relation.value,
            name_col:nameCol.value,
            rel_col:relCol.value,
            name_fuzzy:nameFuzzy.value,
            rel_fuzzy:relFuzzy.value
        })
    });

    const data=await res.json();
    rows=data.rows;
    selectedIndex=0;

    setLoading(`${data.count} results found`);
    render(rows);
}

/* ---------- CLEAR ---------- */
function clearSearch(){
    name.value=""; relation.value="";
    rows=preview; selectedIndex=0;
    setLoading(`Showing preview (${rows.length} rows)`);
    render(rows);
}

/* ---------- UI HELPERS ---------- */
function populateDropdowns(cols){
    nameCol.innerHTML="<option value='ALL'>All Columns</option>";
    relCol.innerHTML="<option value='ALL'>All Columns</option>";
    cols.forEach(c=>{
        nameCol.innerHTML+=`<option>${c}</option>`;
        relCol.innerHTML+=`<option>${c}</option>`;
    });
}

function render(data){
    table.innerHTML="";
    if(!data.length)return;

    const headers=Object.keys(data[0]).filter(h=>h!="_matched");

    let tr=document.createElement("tr");
    headers.forEach(h=>{
        let th=document.createElement("th");
        th.innerText=h; tr.appendChild(th);
    });
    table.appendChild(tr);

    data.forEach((r,i)=>{
        let row=document.createElement("tr");
        let matched=r._matched||[];

        headers.forEach(h=>{
            let td=document.createElement("td");
            td.innerHTML=highlight(r[h],matched);
            row.appendChild(td);
        });

        row.onclick=()=>selectRow(i);
        table.appendChild(row);
    });

    highlightRow();
}

function highlight(text,matched){
    return String(text).split(/\s+/).map(w=>{
        return matched.includes(w.toLowerCase())?`<mark>${w}</mark>`:w;
    }).join(" ");
}

function selectRow(i){
    selectedIndex=i; highlightRow();
}

function highlightRow(){
    [...table.rows].forEach((r,i)=>{
        r.classList.toggle("selected",i===selectedIndex+1);
    });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BLO Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; margin:12px; background:#f7f7f7; }
h2 { margin:6px 0; }

.controls {
  display:flex; flex-wrap:wrap; gap:8px;
  background:#fff; padding:10px;
  border-radius:6px;
  box-shadow:0 1px 4px rgba(0,0,0,.15);
}

.controls input, .controls select, .controls button {
  padding:8px; font-size:14px;
}

.controls button {
  background:#1976d2; color:white;
  border:none; border-radius:4px;
}

.controls button.secondary { background:#555; }
.controls button:disabled { background:#aaa; }

#status { margin:8px 0; color:#1976d2; }

#loader {
  display:none;
  margin:8px 0;
}

.spinner {
  display:inline-block;
  width:18px;
  height:18px;
  border:3px solid #ccc;
  border-top:3px solid #1976d2;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}

#wrap {
  background:#fff;
  border:1px solid #aaa;
  border-radius:4px;
  max-height:65vh;
  overflow:auto;
}

table { border-collapse:collapse; width:100%; }
th, td { border:1px solid #ccc; padding:6px; white-space:nowrap; }
th { background:#eee; position:sticky; top:0; }

tr.selected { background:#cce5ff; }
mark { background:yellow; padding:0 2px; }

.pagination {
  display:flex; justify-content:center;
  gap:10px; margin-top:8px;
}

@media(max-width:768px){
  .controls{flex-direction:column;}
  .controls input,.controls select,.controls button{width:100%;}
}
</style>
</head>

<body>

<h2>BLO Helper</h2>

<div class="controls">
  <input type="file" id="file">
  <button id="uploadBtn" onclick="uploadExcel()">Upload Excel</button>

  <input id="name" placeholder="Name">
  <select id="nameCol"></select>
  <input id="nameFuzzy" type="number" value="70">

  <input id="relation" placeholder="Relation">
  <select id="relCol"></select>
  <input id="relFuzzy" type="number" value="70">

  <button id="searchBtn" onclick="startSearch()">Search</button>
  <button class="secondary" onclick="clearSearch()">Clear</button>
</div>

<div id="status">Choose Excel and click Upload</div>

<div id="loader">
  <span class="spinner"></span>
  <span id="loaderText">Loading…</span>
</div>

<div id="wrap">
  <table id="table"></table>
</div>

<div class="pagination">
  <button onclick="prevPage()">◀ Prev</button>
  <span id="pageInfo">Page 0 / 0</span>
  <button onclick="nextPage()">Next ▶</button>
</div>

<script>
let preview=[], rows=[], page=1, pages=0, selected=0;

function showLoader(text){
  loaderText.innerText=text;
  loader.style.display="block";
  uploadBtn.disabled=true;
  searchBtn.disabled=true;
}

function hideLoader(msg){
  loader.style.display="none";
  uploadBtn.disabled=false;
  searchBtn.disabled=false;
  status.innerText=msg;
}

/* ---------- UPLOAD ---------- */
async function uploadExcel(){
  if(!file.files.length){ status.innerText="Choose Excel first"; return; }

  showLoader("Uploading Excel…");

  const fd=new FormData();
  fd.append("file",file.files[0]);

  const res=await fetch("/upload",{method:"POST",body:fd});
  const data=await res.json();

  preview=data.preview;
  rows=preview;
  fillDropdowns(data.columns);

  hideLoader(`Loaded ${data.total} rows (preview)`);
  pageInfo.innerText="Preview";
  render(rows);
}

/* ---------- SEARCH ---------- */
function startSearch(){ page=1; fetchPage(); }

async function fetchPage(){
    const nameVal = name.value.trim();
    const relVal  = relation.value.trim();

    // ✅ allow name-only, relation-only, or both
    if(!nameVal && !relVal){
        status.innerText = "Please enter Name or Relation to search";
        return;
    }

    showLoader("Searching…");

    const res = await fetch("/search",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            name: nameVal,
            relation: relVal,
            name_col: nameCol.value,
            rel_col: relCol.value,
            name_fuzzy: nameFuzzy.value,
            rel_fuzzy: relFuzzy.value,
            page: page
        })
    });

    const data = await res.json();
    rows = data.rows;
    pages = data.pages;
    selected = 0;

    hideLoader(`${data.total} results found`);
    pageInfo.innerText = `Page ${page} / ${pages}`;

    render(rows);
}

/* ---------- PAGINATION ---------- */
function nextPage(){ if(page<pages){ page++; fetchPage(); } }
function prevPage(){ if(page>1){ page--; fetchPage(); } }

/* ---------- CLEAR ---------- */
function clearSearch(){
  name.value=""; relation.value="";
  rows=preview; page=1; pages=0;
  status.innerText=`Showing preview (${rows.length})`;
  pageInfo.innerText="Preview";
  render(rows);
}

/* ---------- RENDER ---------- */
function render(data){
  table.innerHTML="";
  if(!data.length)return;

  const headers=Object.keys(data[0]).filter(h=>h!="_matched");

  let tr=document.createElement("tr");
  headers.forEach(h=>{
    let th=document.createElement("th");
    th.innerText=h; tr.appendChild(th);
  });
  table.appendChild(tr);

  data.forEach((r,i)=>{
    let row=document.createElement("tr");
    let matched=r._matched||[];

    headers.forEach(h=>{
      let td=document.createElement("td");
      td.innerHTML=highlight(r[h],matched);
      row.appendChild(td);
    });

    row.onclick=()=>selectRow(i);
    table.appendChild(row);
  });

  highlightRow();
}

function highlight(text,matched){
  return String(text).split(/\s+/).map(w=>{
    return matched.includes(w.toLowerCase())?`<mark>${w}</mark>`:w;
  }).join(" ");
}

function selectRow(i){ selected=i; highlightRow(); }
function highlightRow(){
  [...table.rows].forEach((r,i)=>{
    r.classList.toggle("selected",i===selected+1);
  });
}

function fillDropdowns(cols){
  nameCol.innerHTML="<option value='ALL'>All Columns</option>";
  relCol.innerHTML="<option value='ALL'>All Columns</option>";
  cols.forEach(c=>{
    nameCol.innerHTML+=`<option>${c}</option>`;
    relCol.innerHTML+=`<option>${c}</option>`;
  });
}
</script>

</body>
</html>
